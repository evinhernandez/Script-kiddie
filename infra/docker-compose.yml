version: "3.9"

services:
  postgres:
    image: postgres:16
    container_name: scriptkiddie-postgres
    environment:
      POSTGRES_USER: scriptkiddie
      POSTGRES_PASSWORD: scriptkiddie
      POSTGRES_DB: scriptkiddie
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: scriptkiddie-redis
    ports: ["6379:6379"]

  ollama:
    image: ollama/ollama:latest
    container_name: scriptkiddie-ollama
    ports: ["11434:11434"]
    volumes:
      - ollama:/root/.ollama

  api:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
    env_file:
      - ../apps/api/.env
    depends_on: [postgres, redis, ollama]
    ports: ["8000:8000"]
    volumes:
      - ..:/workspace
      - "/Users/ehernandez/Library/Mobile Documents/com~apple~CloudDocs/Script Kiddie/script-kiddie:/scan"

  worker:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
    command: ["bash", "-lc", "celery -A app.worker.celery_app worker -l info"]
    env_file:
      - ../apps/api/.env
    depends_on: [api, redis, postgres, ollama]
    volumes:
      - ..:/workspace
      - "/Users/ehernandez/Library/Mobile Documents/com~apple~CloudDocs/Script Kiddie/script-kiddie:/scan"

  web:
    build:
      context: ../apps/web
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: "http://localhost:8000"
      NEXT_PUBLIC_API_KEY: "dev-local-key"
    depends_on: [api]
    ports: ["3000:3000"]
    volumes:
      - ../apps/web:/app
      - /app/node_modules

volumes:
  pgdata:
  ollama:
