services:
  postgres:
    image: postgres:16
    container_name: scriptkiddie-postgres
    environment:
      POSTGRES_USER: scriptkiddie
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in your environment}
      POSTGRES_DB: scriptkiddie
    # Only expose to internal network — remove port mapping for production
    # ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: scriptkiddie-redis
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:?Set REDIS_PASSWORD in your environment}"]
    # Only expose to internal network
    # ports: ["6379:6379"]

  ollama:
    image: ollama/ollama:latest
    container_name: scriptkiddie-ollama
    # Only expose to internal network
    # ports: ["11434:11434"]
    volumes:
      - ollama:/root/.ollama

  api:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
    env_file:
      - ../apps/api/.env
    depends_on: [postgres, redis, ollama]
    ports: ["8000:8000"]
    volumes:
      # Mount only what the scanner needs — read-only where possible
      - ../rulesets:/workspace/rulesets:ro
      - ../policies:/workspace/policies:ro
      - ../snippets:/workspace/snippets:ro

  worker:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
    command: ["bash", "-lc", "celery -A app.worker.celery_app worker -l info"]
    env_file:
      - ../apps/api/.env
    depends_on: [api, redis, postgres, ollama]
    volumes:
      - ../rulesets:/workspace/rulesets:ro
      - ../policies:/workspace/policies:ro

  web:
    build:
      context: ../apps/web
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: "http://localhost:8000"
      # API key is NOT exposed to the client — requests go through server-side proxy
    depends_on: [api]
    ports: ["3000:3000"]

volumes:
  pgdata:
  ollama:
